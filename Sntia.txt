-- Check for orphaned CDM_EFFECTIVE_DEPTARTMENT_KEY (no matching record in TBL_DEPARTMENT_KEY)
SELECT COUNT(*) AS Missing_Effective_Dept_Keys
FROM [CDM].[TBL_PATIENT_ENCOUNTER_DETAILS] WITH (NOLOCK)
WHERE CDM_EFFECTIVE_DEPTARTMENT_KEY NOT IN (
    SELECT CDM_DEPARTMENT_KEY 
    FROM [CDM].[TBL_DEPARTMENT_KEY] WITH (NOLOCK)
);

-- Check for orphaned CDM_Patient_Coverage_Key (no matching record in TBL_PATIENT_COVERAGE_KEY)
SELECT COUNT(*) AS Missing_Coverage_Keys
FROM [CDM].[TBL_PATIENT_ENCOUNTER_DETAILS] WITH (NOLOCK)
WHERE CDM_Patient_Coverage_Key NOT IN (
    SELECT CDM_PATIENT_COVERAGE_KEY 
    FROM [CDM].[TBL_PATIENT_COVERAGE_KEY] WITH (NOLOCK)
);

-- Check for orphaned CDM_Department_Key (no matching record in TBL_DEPARTMENT_KEY)
SELECT COUNT(*) AS Missing_Dept_Keys
FROM [CDM].[TBL_PATIENT_ENCOUNTER_DETAILS] WITH (NOLOCK)
WHERE CDM_Department_Key NOT IN (
    SELECT CDM_DEPARTMENT_KEY 
    FROM [CDM].[TBL_DEPARTMENT_KEY] WITH (NOLOCK)
);

-- Check for orphaned CDM_Patient_Key (no matching record in TBL_PATIENT_KEY)
SELECT COUNT(*) AS Missing_Patient_Keys
FROM [CDM].[TBL_PATIENT_ENCOUNTER_DETAILS] WITH (NOLOCK)
WHERE CDM_Patient_Key NOT IN (
    SELECT CDM_PATIENT_KEY 
    FROM [CDM].[TBL_PATIENT_KEY] WITH (NOLOCK)
);
